<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í•™ì‚¬ì¼ì •</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
      /* Basic CSS Reset and Font Smoothing */
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      /* Custom style for responsive calendar header (for multiday events) */
      .grid-rows-auto {
        grid-auto-rows: minmax(100px, 1fr); 
      }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react": "https://esm.sh/react@18.2.0",
        "date-fns": "https://esm.sh/date-fns@3.6.0"
      }
    }
    </script>

    <script>
      // Tailwind CSS Configuration - wait for tailwind to load
      if (typeof tailwind !== 'undefined') {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Inter', 'Noto Sans KR', 'sans-serif'],
              },
            },
          },
        }
      }
      
      /**
       * base64 ë¬¸ìì—´ì„ ArrayBufferë¡œ ë””ì½”ë”©í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
       * XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ base64 ë°ì´í„°ë¥¼ ì²˜ë¦¬í•  ë•Œ í•„ìš”í•©ë‹ˆë‹¤.
       */
      const base64ToArrayBuffer = (base64) => {
        const binaryString = window.atob(base64.split(',')[1]);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
      };
      
      /**
       * ì—‘ì…€ íŒŒì¼ (XLSX, XLS)ì„ ì½ì–´ ì²« ë²ˆì§¸ ì‹œíŠ¸ë¥¼ CSV ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
       */
      const processExcelFile = (file, callback, onError) => {
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  const data = event.target.result;
                  const workbook = XLSX.read(data, { type: 'binary' });
                  const sheetName = workbook.SheetNames[0];
                  const worksheet = workbook.Sheets[sheetName];
                  
                  // ì‹œíŠ¸ë¥¼ CSV í˜•ì‹ ë¬¸ìì—´ë¡œ ë³€í™˜
                  const csv = XLSX.utils.sheet_to_csv(worksheet, { FS: ',', RS: '\n' });
                  callback(csv);
              } catch (e) {
                  console.error("Error processing Excel file:", e);
                  onError("ì—‘ì…€ íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
              }
          };
          reader.onerror = (e) => {
              console.error("Error reading file:", e);
              onError("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          };
          
          // íŒŒì¼ í™•ì¥ìì— ë”°ë¼ ì½ëŠ” ë°©ì‹ì„ ë‹¤ë¥´ê²Œ ì²˜ë¦¬
          const fileName = file.name.toLowerCase();
          if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
              reader.readAsBinaryString(file);
          } else {
              onError("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
          }
      };

      /**
       * CSV íŒŒì¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ì½ëŠ” í•¨ìˆ˜
       */
      const processCsvFile = (file, callback, onError) => {
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  let text = event.target.result;
                  // UTF-8 BOM ì œê±°
                  if (text.charCodeAt(0) === 0xFEFF) {
                      text = text.slice(1);
                  }
                  // CR/LF ì •ê·œí™”
                  text = text.replace(/\r\n|\r/g, '\n');
                  callback(text);
              } catch (e) {
                  console.error('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', e);
                  onError("CSV íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
          };
          reader.onerror = (e) => {
              console.error("Error reading file:", e);
              onError("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          };
          reader.readAsText(file);
      };
    </script>
</head>
<body class="bg-gradient-to-br from-sky-200 to-blue-100 p-2 sm:p-4 lg:p-8 min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useCallback, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import {
            eachDayOfInterval,
            endOfMonth,
            endOfWeek,
            format,
            isSameMonth,
            isToday,
            startOfMonth,
            startOfWeek as dateFnsStartOfWeek
        } from 'date-fns';

        // --- START: data/schoolData.ts ---
        const rawEventsCsv = ``;

        const rawHolidaysCsv = ``;

        const rawDutiesCsv = ``;
        // --- END: data/schoolData.ts ---

        // --- START: utils/dataProcessor.ts ---
        
        /**
         * [ìˆ˜ì •] YYYY-MM-DD, YYYY.MM.DD, MM/DD/YYYY ë“± ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ì„ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
         */
        const parseDate = (dateStr) => {
            if (!dateStr) return null;

            // 1. Try YYYY-MM-DD or YYYY.MM.DD (Korean format)
            // (Clean . and spaces)
            let cleanedStr = dateStr.replace(/\./g, '-').replace(/\s/g, '');
            let parts = cleanedStr.split('-').filter(p => p);
            
            if (parts.length === 3) {
                const [year, month, day] = parts.map(p => parseInt(p, 10));
                //
                if (!isNaN(year) && year > 1900 && !isNaN(month) && month >= 1 && month <= 12 && !isNaN(day) && day >= 1 && day <= 31) {
                    return new Date(year, month - 1, day); // month is 0-indexed
                }
            }

            // 2. Try MM/DD/YYYY or MM.DD.YYYY (US format, common from Excel)
            // (Clean . and spaces)
            cleanedStr = dateStr.replace(/\./g, '/').replace(/\s/g, '');
            parts = cleanedStr.split('/');
            
            if (parts.length === 3) {
                const [month, day, year] = parts.map(p => parseInt(p, 10));
                if (!isNaN(year) && year > 1900 && !isNaN(month) && month >= 1 && month <= 12 && !isNaN(day) && day >= 1 && day <= 31) {
                    return new Date(year, month - 1, day); // month is 0-indexed
                }
            }
            
            // 3. Last resort: try native Date parser (can be unreliable but might work)
            const date = new Date(dateStr);
            if (date instanceof Date && !isNaN(date)) {
                return date;
            }

            return null; // All attempts failed
        };


        const formatDateKey = (date) => {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };

        /**
         * [ìˆ˜ì •] ë”°ì˜´í‘œë¡œ ë¬¶ì¸ í•„ë“œ(ë‚´ë¶€ì— ì‰¼í‘œê°€ ìˆì„ ìˆ˜ ìˆìŒ)ë¥¼ ì˜¬ë°”ë¥´ê²Œ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
         */
        const parseCsvLine = (line) => {
            const fields = [];
            let currentField = '';
            let inQuotes = false;

            for (const char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    fields.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            fields.push(currentField.trim());
            // í•„ë“œì˜ ì•ë’¤ í°ë”°ì˜´í‘œ ì œê±° (CSV íŒŒì‹± í‘œì¤€ì— ë”°ë¦„)
            return fields.map(f => f.replace(/^"|"$/g, ''));
        };

        const parseEventsCsv = (csvText) => {
            const lines = csvText.trim().split('\n').slice(1);
            const events = [];
            lines.forEach(line => {
                if (!line.trim()) return; // ë¹ˆ ì¤„ ê±´ë„ˆë›°ê¸°
                const [date, ...eventParts] = parseCsvLine(line);
                const eventStrings = eventParts.map(e => e.trim().replace(/"/g, '')).filter(e => e);
                if (date && eventStrings.length > 0) {
                    events.push({ date, events: eventStrings });
                }
            });
            return events;
        };

        const parseHolidaysCsv = (csvText) => {
            const lines = csvText.trim().split('\n').slice(1);
            const holidays = [];
            lines.forEach(line => {
                if (!line.trim()) return; // ë¹ˆ ì¤„ ê±´ë„ˆë›°ê¸°
                const [dateStr, name] = parseCsvLine(line);
                const date = parseDate(dateStr);
                if (date && name) {
                    holidays.push({ date, name: name.trim() });
                }
            });
            return holidays;
        };

        const parseTeachersCsv = (csvText) => {
            const lines = csvText.trim().split('\n').slice(1);
            const duties = [];
            lines.forEach(line => {
                if (!line.trim()) return; // ë¹ˆ ì¤„ ê±´ë„ˆë›°ê¸°
                const [dateStr, _day, teacher] = parseCsvLine(line);
                const date = parseDate(dateStr);
                if (date && teacher && teacher.trim()) {
                    duties.push({ date, teacher: teacher.trim() });
                }
            });
            return duties;
        };

        // --- [FIX 1] START: ì„¸ë ¨ëœ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ë¡œ ë³€ê²½ ---
        const EVENT_COLORS = [
            // ë°ì€ íŒŒìŠ¤í…”í†¤ (ì–´ë‘ìš´ ê¸€ì”¨)
            { bg: 'bg-sky-100', text: 'text-sky-900' },
            { bg: 'bg-emerald-100', text: 'text-emerald-900' },
            { bg: 'bg-amber-100', text: 'text-amber-900' },
            { bg: 'bg-violet-100', text: 'text-violet-900' },
            { bg: 'bg-rose-100', text: 'text-rose-900' },
            { bg: 'bg-lime-100', text: 'text-lime-900' },
            // ì„¸ë ¨ëœ ì¤‘ê°„/ì–´ë‘ìš´ í†¤ (í°ìƒ‰ ê¸€ì”¨)
            { bg: 'bg-indigo-500', text: 'text-white' },
            { bg: 'bg-emerald-600', text: 'text-white' },
            { bg: 'bg-pink-400', text: 'text-white' },
            { bg: 'bg-orange-500', text: 'text-white' }
        ];
        // --- [FIX 1] END ---

        const simpleHash = (str) => {
          let hash = 0;
          for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash |= 0; 
          }
          return Math.abs(hash);
        };
        
        const getEventColor = (eventTitle) => {
            
            // --- [MODIFIED] START: ììœ¨/ë™ì•„ë¦¬ í™œë™ ìš°ì„  ê²€ì‚¬ ---
            // 'í‰ê°€'ë³´ë‹¤ ìš°ì„ ìˆœìœ„ë¥¼ ë†’ì´ê¸° ìœ„í•´ ì´ ë¸”ë¡ì„ ìœ„ë¡œ ì´ë™
            const activityKeywords = ['ììœ¨', 'ì ì‘', 'ë™ì•„ë¦¬', 'ë´‰ì‚¬'];
            const activityColor = 'bg-teal-500 text-white'; // ì„¸ë ¨ëœ ë…¹ìƒ‰(ì²­ë¡ìƒ‰)
            
            for (const keyword of activityKeywords) {
                if (eventTitle.includes(keyword)) {
                    return activityColor;
                }
            }
            // --- [MODIFIED] END ---

            // --- [ìˆ˜ì •ëœ ë¶€ë¶„] START: í‰ê°€/ê³ ì‚¬/ìˆ˜ëŠ¥ í‚¤ì›Œë“œ ìƒ‰ìƒ í†µì¼ ---
            const specialKeywords = {
                'ê³ ì‚¬': 'bg-red-500 text-white font-bold',
                'í‰ê°€': 'bg-red-500 text-white font-bold',
                'ì‹œí—˜': 'bg-red-500 text-white font-bold', // í‚¤ì›Œë“œ ì¶”ê°€
                'ë°©í•™': 'bg-blue-500 text-white',
                'ê°œí•™': 'bg-blue-500 text-white',
                'ì¡¸ì—…': 'bg-purple-500 text-white',
                'ì…í•™': 'bg-purple-500 text-white',
            };
            // --- [ìˆ˜ì •ëœ ë¶€ë¶„] END ---

            for (const keyword in specialKeywords) {
                if (eventTitle.includes(keyword)) {
                    return specialKeywords[keyword];
                }
            }
            
            // --- [NEW FIX] START: ì£¼ì œë³„ í‚¤ì›Œë“œ ìƒ‰ìƒ í†µì¼ (ì¸ë¬¸, ê³¼í•™ ë“±) ---
            const themedKeywords = [
                { keywords: ['ì¸ë¬¸', 'ë…ì„œ'], color: 'bg-purple-600 text-white' },
                { keywords: ['ê³¼í•™'], color: 'bg-blue-600 text-white' },
                { keywords: ['ì˜ˆìˆ ', 'ë¯¸ìˆ ', 'ìŒì•…'], color: 'bg-rose-500 text-white' },
                { keywords: ['ì²´ìœ¡', 'ìŠ¤í¬ì¸ ', 'ìˆ˜ë ¨íšŒ'], color: 'bg-lime-600 text-white' },
                // --- [í‚¤ì›Œë“œ ìƒ‰ìƒ ë³€ê²½] START: orange -> yellow ---
                { keywords: ['êµì›', 'êµì§ì›íšŒì˜', 'ì—°ìˆ˜', 'í˜‘ì˜íšŒ'], color: 'bg-yellow-500 text-white' }
                // --- [í‚¤ì›Œë“œ ìƒ‰ìƒ ë³€ê²½] END ---
            ];
    
            for (const theme of themedKeywords) {
                for (const keyword of theme.keywords) {
                    if (eventTitle.includes(keyword)) {
                        return theme.color;
                    }
                }
            }
            // --- [NEW FIX] END ---

            const hash = simpleHash(eventTitle);
            const color = EVENT_COLORS[hash % EVENT_COLORS.length];
            
            // --- [FIX 3] START: ë°°ê²½ìƒ‰ê³¼ ê¸€ììƒ‰ì„ í•¨ê»˜ ë°˜í™˜ ---
            return `${color.bg} ${color.text}`;
            // --- [FIX 3] END ---
        };

        const findAndProcessMultiDayEvents = (dayDataMap) => {
            const multiDayEvents = [];
            const processedEventIds = new Set();

            const sortedDates = Array.from(dayDataMap.keys()).sort();

            for (const dateKey of sortedDates) {
                const dayData = dayDataMap.get(dateKey);
                if (!dayData) continue;

                for (const event of dayData.events) {
                    // ì´ë²¤íŠ¸ IDëŠ” ë‚ ì§œì™€ ì´ë²¤íŠ¸ ì „ì²´ ì œëª©ìœ¼ë¡œ ìƒì„±
                    const eventId = `${dateKey}_${event.fullTitle}`;
                    if (processedEventIds.has(eventId)) continue;

                    // ì œëª©ì—ì„œ 'Xì¼ì°¨' ë˜ëŠ” '(X)' ë¶€ë¶„ì„ ì œê±°í•˜ì—¬ ê¸°ë³¸ ì œëª© ì¶”ì¶œ
                    const baseTitleMatch = event.fullTitle.match(/^(.*?)(\s*\d+ì¼ì°¨|\s*\(\d+\)|1ì¼ì°¨)?$/);
                    const baseTitle = baseTitleMatch ? baseTitleMatch[1].trim() : event.fullTitle;
                    
                    if (!baseTitle) continue;

                    let endDate = new Date(dayData.date);
                    const currentRunEventIds = [eventId];

                    let currentCheckDate = new Date(dayData.date);
                    currentCheckDate.setDate(currentCheckDate.getDate() + 1);
                    let nextDateKey = formatDateKey(currentCheckDate);

                    // ë‹¤ìŒ ë‚ ì§œë¥¼ ìˆœíšŒí•˜ë©° ê°™ì€ ì´ë²¤íŠ¸ì˜ ì—°ì†ì„± í™•ì¸
                    while (dayDataMap.has(nextDateKey)) {
                        const nextDayData = dayDataMap.get(nextDateKey);
                        const nextDayEvent = nextDayData.events.find(e => {
                             const nextBaseTitleMatch = e.fullTitle.match(/^(.*?)(\s*\d+ì¼ì°¨|\s*\(\d+\))?$/);
                             return nextBaseTitleMatch && nextBaseTitleMatch[1].trim() === baseTitle;
                        });

                        if (nextDayEvent) {
                            endDate = new Date(nextDayData.date);
                            currentRunEventIds.push(`${nextDateKey}_${nextDayEvent.fullTitle}`);
                        } else {
                            break;
                        }
                        currentCheckDate.setDate(currentCheckDate.getDate() + 1);
                        nextDateKey = formatDateKey(currentCheckDate);
                    }
                    
                    // 2ì¼ ì´ìƒ ì—°ì†ëœ ì´ë²¤íŠ¸ë§Œ ë©€í‹°ë°ì´ ì´ë²¤íŠ¸ë¡œ ë“±ë¡
                    if (endDate > dayData.date) {
                        multiDayEvents.push({
                            id: `${baseTitle}_${formatDateKey(dayData.date)}`,
                            start: dayData.date,
                            end: endDate,
                            title: baseTitle,
                            color: getEventColor(event.fullTitle),
                        });
                        // ì²˜ë¦¬ëœ ì´ë²¤íŠ¸ IDë¥¼ ê¸°ë¡
                        currentRunEventIds.forEach(id => processedEventIds.add(id));
                    }
                }
            }
            
            // ë ˆì¸ ê´€ë¦¬ ë¡œì§ (ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì´ë²¤íŠ¸ ë°°ì¹˜)
            const laneManagedEvents = [];
            multiDayEvents.sort((a,b) => a.start.getTime() - b.start.getTime());

            for (const event of multiDayEvents) {
                let lane = 0;
                while(true) {
                    // í˜„ì¬ ë ˆì¸ì— ì´ ì´ë²¤íŠ¸ì™€ ì‹œê°„ì´ ê²¹ì¹˜ëŠ” ì´ë²¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
                    const conflictingEvent = laneManagedEvents.find(e => e.lane === lane && !(event.start > e.end || event.end < e.start));
                    if (!conflictingEvent) {
                        laneManagedEvents.push({ ...event, lane });
                        break;
                    }
                    lane++;
                }
            }

            return { multiDayEvents: laneManagedEvents, processedEventIds };
        };


        const processCalendarData = (rawEvents, holidays, duties) => {
            const dayDataMap = new Map();

            // 1. í•™ì‚¬ì¼ì • ì´ë²¤íŠ¸ ì²˜ë¦¬
            rawEvents.forEach(rawEvent => {
                const date = parseDate(rawEvent.date);
                if (date) {
                    const key = formatDateKey(date);
                    if (!dayDataMap.has(key)) {
                        dayDataMap.set(key, { date, events: [], holiday: null, teacherDuty: null });
                    }
                    const dayData = dayDataMap.get(key);
                    rawEvent.events.forEach(eventTitle => {
                        dayData.events.push({
                            title: eventTitle.length > 15 ? eventTitle.substring(0, 12) + '...' : eventTitle,
                            fullTitle: eventTitle,
                            color: getEventColor(eventTitle),
                        });
                    });
                }
            });

            // 2. ê³µíœ´ì¼ ì²˜ë¦¬
            holidays.forEach(holiday => {
                const key = formatDateKey(holiday.date);
                if (!dayDataMap.has(key)) {
                    dayDataMap.set(key, { date: holiday.date, events: [], holiday: null, teacherDuty: null });
                }
                dayDataMap.get(key).holiday = holiday;
            });

            // 3. ë‹¹ì§ êµì‚¬ (íŠ¹ë³„ í–‰ì‚¬) ì²˜ë¦¬
            duties.forEach(duty => {
                const key = formatDateKey(duty.date);
                if (!dayDataMap.has(key)) {
                    dayDataMap.set(key, { date: duty.date, events: [], holiday: null, teacherDuty: null });
                }
                dayDataMap.get(key).teacherDuty = duty;
            });

            // 4. ë©€í‹°ë°ì´ ì´ë²¤íŠ¸ ê°ì§€ ë° ì²˜ë¦¬
            const { multiDayEvents, processedEventIds } = findAndProcessMultiDayEvents(dayDataMap);

            // 5. ë©€í‹°ë°ì´ ì´ë²¤íŠ¸ë¡œ ì²˜ë¦¬ëœ ë‹¨ì¼ ì´ë²¤íŠ¸ ì œê±°
            for (const [key, dayData] of dayDataMap.entries()) {
                dayData.events = dayData.events.filter(event => {
                    const eventId = `${key}_${event.fullTitle}`;
                    return !processedEventIds.has(eventId);
                });
            }

            return { dayDataMap, multiDayEvents };
        };
        // --- END: utils/dataProcessor.ts ---

        // --- START: components/EventModal.tsx ---
        const XMarkIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const EventModal = ({ dayData, onClose }) => {
            const { date, events, holiday, teacherDuty } = dayData;
            
            const formattedDate = `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;

            return (
                <div 
                    className="fixed inset-0 bg-black/50 z-50 flex justify-center items-center p-4"
                    onClick={onClose}
                >
                    <div 
                        className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[80vh] flex flex-col"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <header className="p-4 border-b border-slate-200 flex justify-between items-center">
                            <h2 className="text-lg font-bold text-slate-800">{formattedDate}</h2>
                            <button onClick={onClose} className="p-1 rounded-full text-slate-400 hover:bg-slate-100">
                                <XMarkIcon />
                            </button>
                        </header>
                        <div className="flex-grow p-4 overflow-y-auto space-y-4">
                            {holiday && (
                                <div>
                                    <h3 className="font-semibold text-slate-700 text-sm mb-1 uppercase tracking-wider">ê³µíœ´ì¼</h3>
                                    <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
                                        <p className="font-bold text-red-700">{holiday.name}</p>
                                    </div>
                                </div>
                            )}
                            {events.length > 0 && (
                                <div>
                                    <h3 className="font-semibold text-slate-700 text-sm mb-2 uppercase tracking-wider">í•™ì‚¬ ì¼ì •</h3>
                                    <ul className="space-y-2">
                                        {events.map((event, index) => (
                                            // ëª¨ë‹¬ ë‚´ë¶€ëŠ” ê°€ë…ì„±ì„ ìœ„í•´ event.colorë¥¼ ì‚¬ìš©
                                            <li key={index} className={`p-2 rounded-lg text-sm font-medium ${event.color.startsWith('bg-') ? event.color : 'bg-slate-100'} ${event.color.includes('text-white') ? 'text-white' : 'text-black'}`}>
                                                {event.fullTitle}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                             {teacherDuty && (
                                 <div>
                                    <h3 className="font-semibold text-slate-700 text-sm mb-1 uppercase tracking-wider">íŠ¹ë³„ í–‰ì‚¬ / ì§€ë„ êµì‚¬</h3>
                                    <div className="p-3 bg-slate-100 border border-slate-200 rounded-lg">
                                        <p className="text-slate-800 font-medium">{teacherDuty.teacher}</p>
                                    </div>
                                </div>
                            )}
                            {!holiday && events.length === 0 && !teacherDuty && (
                                 <div className="text-center py-10">
                                    <p className="text-slate-500">ì´ ë‚ ì§œì—ëŠ” ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                 </div>
                            )}
                        </div>
                         <footer className="p-3 bg-slate-50 border-t border-slate-200 text-right">
                            <button 
                                onClick={onClose}
                                className="px-4 py-2 bg-slate-600 text-white text-sm font-semibold rounded-lg hover:bg-slate-700"
                            >
                                ë‹«ê¸°
                            </button>
                        </footer>
                    </div>
                </div>
            );
        };
        // --- END: components/EventModal.tsx ---

        // --- START: components/Header.tsx ---
        const ChevronLeftIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
        );

        const ChevronRightIcon = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
            </svg>
        );

        const MiniCalendar = ({ date, startOfWeek }) => {
            const monthStart = startOfMonth(date);
            const monthEnd = endOfMonth(date);
            const calendarStart = dateFnsStartOfWeek(monthStart, { weekStartsOn: startOfWeek });
            const calendarEnd = endOfWeek(monthEnd, { weekStartsOn: startOfWeek });
            const days = eachDayOfInterval({ start: calendarStart, end: calendarEnd });

            let dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            if (startOfWeek === 1) {
                dayHeaders.push(dayHeaders.shift()); // ì›”ìš”ì¼ ì‹œì‘ìœ¼ë¡œ ë³€ê²½
            }

            return (
                <div className="w-48">
                    <h3 className="text-center font-semibold text-sm mb-2 text-slate-700">{format(date, 'MMMM yyyy')}</h3>
                    <div className="grid grid-cols-7 text-center text-xs text-slate-500">
                        {dayHeaders.map(day => <div key={day} className="h-4 flex items-center justify-center">{day}</div>)}
                    </div>
                    <div className="grid grid-cols-7 text-center text-xs mt-1">
                        {days.map(day => {
                            const dayOfWeek = day.getDay();
                            const isCurrentMonth = isSameMonth(day, date);

                            let textColor = 'text-slate-600';
                            if (!isCurrentMonth) {
                                textColor = 'text-slate-300';
                            } else if (dayOfWeek === 0) { // Sunday
                                textColor = 'text-red-500';
                            } else if (dayOfWeek === 6) { // Saturday
                                textColor = 'text-blue-500';
                            }

                            return (
                                <div
                                    key={day.toString()}
                                    className={`
                                        w-6 h-4 flex items-center justify-center rounded-full
                                        ${isToday(day) ? 'bg-blue-600 text-white shadow-md' : textColor}
                                    `}
                                >
                                    {format(day, 'd')}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Header = ({ viewDate, setViewDate, startOfWeek, setStartOfWeek, onReset, onShowDataModal, schoolName, schoolLogo }) => {
            const currentYear = viewDate.getFullYear();
            const currentMonth = viewDate.getMonth();

            const goToPreviousMonth = () => setViewDate(new Date(currentYear, currentMonth - 1, 1));
            const goToNextMonth = () => setViewDate(new Date(currentYear, currentMonth + 1, 1));
            const goToToday = () => setViewDate(new Date());

            const prevMonth = new Date(currentYear, currentMonth - 1, 1);
            const nextMonth = new Date(currentYear, currentMonth + 1, 1);
            
            const selectBaseClasses = "bg-white text-slate-700 text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50";
            const buttonBaseClasses = `px-3 py-2 border border-gray-300 bg-white text-slate-700 text-sm font-medium rounded-md shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500`;

            return (
                <header className="bg-white shadow-sm sticky top-0 z-20">
                     <div className="p-2 flex justify-between items-center gap-4">
                        <div className="hidden lg:block">
                            <MiniCalendar date={prevMonth} startOfWeek={startOfWeek} />
                        </div>
                        <div className="text-center p-4 sm:p-6 rounded-xl shadow-lg bg-gradient-to-r from-sky-500 to-indigo-600 text-white select-none flex-grow">
                            <h1 className="text-2xl sm:text-3xl font-bold">ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¿¨ ìº˜ë¦°ë”</h1>
                            <p className="text-sm sm:text-base mt-1">{schoolName ? schoolName + " " : ""}í•™ì‚¬ ì¼ì • ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                        </div>
                        <div className="hidden lg:block">
                            <MiniCalendar date={nextMonth} startOfWeek={startOfWeek} />
                        </div>
                     </div>

                    <div className="p-2 border-t border-slate-200 flex items-center justify-between flex-wrap gap-2">
                         <div className="flex items-center gap-2 sm:gap-4">
                            {schoolLogo ? (
                                <img src={schoolLogo} alt="School Logo" className="h-10 sm:h-12 object-contain" />
                            ) : (
                                <span className="font-bold text-xl text-slate-700">ğŸ«</span>
                            )}
                            <button onClick={goToToday} className={buttonBaseClasses}>
                                ì˜¤ëŠ˜
                            </button>
                        </div>
                        
                        <div className="flex items-center absolute left-1/2 -translate-x-1/2">
                            <button onClick={goToPreviousMonth} className="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors">
                                <ChevronLeftIcon />
                            </button>
                            <h2 className="text-lg font-semibold text-slate-800 w-32 text-center">
                                {`${currentYear}ë…„ ${currentMonth + 1}ì›”`}
                            </h2>
                            <button onClick={goToNextMonth} className="p-2 rounded-full text-slate-500 hover:bg-slate-100 transition-colors">
                                <ChevronRightIcon />
                            </button>
                        </div>
                        
                        <div className="flex items-center gap-2">
                            <select value={startOfWeek} onChange={(e) => setStartOfWeek(Number(e.target.value))} className={selectBaseClasses}>
                                <option value={0}>ì¼ìš”ì¼ ì‹œì‘</option>
                                <option value={1}>ì›”ìš”ì¼ ì‹œì‘</option>
                            </select>
                            <button 
                                onClick={onShowDataModal}
                                className="px-3 py-2 border border-gray-300 bg-blue-50 text-blue-700 text-sm font-medium rounded-md shadow-sm hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                            >
                                ë°ì´í„° ì„¤ì •
                            </button>
                            <button 
                                onClick={onReset}
                                className="px-3 py-2 border border-gray-300 bg-red-50 text-red-700 text-sm font-medium rounded-md shadow-sm hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                            >
                                ë°ì´í„° ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </header>
            );
        };
        // --- END: components/Header.tsx ---

        // --- START: components/Calendar.tsx ---
        const DayCell = ({ date, dayData, isToday, isCurrentMonth, reservedHeight, onClick }) => {
            const dayNumber = date.getDate();
            const dayOfWeek = date.getDay();

            const dayNumberColor = dayData?.holiday ? 'text-red-500' :
                dayOfWeek === 0 ? 'text-red-500' :
                dayOfWeek === 6 ? 'text-blue-500' :
                isCurrentMonth ? 'text-slate-700' : 'text-slate-400';

            const hasContent = (dayData?.events.length ?? 0) > 0 || dayData?.holiday || dayData?.teacherDuty;

            const MAX_ITEMS_IN_CELL = 3;
            const singleDayEvents = dayData?.events || [];
            const displayableItems = [];
            
            // ê³µíœ´ì¼ì´ ìˆìœ¼ë©´ í•­ìƒ ì²« ë²ˆì§¸ í•­ëª©ìœ¼ë¡œ ì¶”ê°€ (ìš°ì„ ìˆœìœ„ ë¶€ì—¬)
            let remainingSlots = MAX_ITEMS_IN_CELL;
            
            if (dayData?.holiday) {
                displayableItems.push({ type: 'holiday', content: dayData.holiday });
                remainingSlots--;
            }
            
            // ë‚˜ë¨¸ì§€ ì´ë²¤íŠ¸ í•­ëª©ì„ ë‚¨ì€ ìŠ¬ë¡¯ ë‚´ì—ì„œë§Œ ì¶”ê°€
            singleDayEvents.forEach(event => {
                if (remainingSlots > 0) {
                    displayableItems.push({ type: 'event', content: event });
                    remainingSlots--;
                }
            });
            
            // ì „ì²´ í•­ëª© ìˆ˜ (ê³µíœ´ì¼ + ëª¨ë“  ì´ë²¤íŠ¸)
            const totalItems = (dayData?.holiday ? 1 : 0) + singleDayEvents.length;
            // í‘œì‹œëœ í•­ëª© ìˆ˜
            const displayedCount = displayableItems.length;
            // ë”ë³´ê¸° í•­ëª© ìˆ˜
            const moreItemsCount = totalItems - displayedCount;
            const hasMoreItems = moreItemsCount > 0;

            return (
                <div
                    className={`border-b border-r border-slate-300 flex flex-col relative transition-all duration-200 ${isCurrentMonth ? 'bg-gradient-to-br from-white to-slate-50' : 'bg-gradient-to-br from-slate-50/80 to-slate-100/60'} ${hasContent ? 'cursor-pointer hover:shadow-md hover:border-blue-300' : 'hover:shadow-sm'}`}
                    style={{
                        boxShadow: isCurrentMonth 
                            ? 'inset 1px 1px 0 rgba(255,255,255,0.9), inset -1px -1px 0 rgba(0,0,0,0.05), 0 3px 8px rgba(59,130,246,0.12)' 
                            : 'inset 1px 1px 0 rgba(255,255,255,0.6), inset -1px -1px 0 rgba(0,0,0,0.02), 0 2px 4px rgba(0,0,0,0.05)',
                    }}
                    onClick={() => dayData && hasContent && onClick(dayData)}
                >
                    <div className="flex-shrink-0 p-1 text-center">
                        <div className={`text-sm font-bold mx-auto transition-all duration-150 ${dayNumberColor} ${isToday ? 'bg-gradient-to-b from-blue-500 to-blue-700 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-lg shadow-blue-400/40' : 'w-7 h-7 flex items-center justify-center'}`}
                             style={!isToday && isCurrentMonth ? {
                                textShadow: '0 1px 2px rgba(0,0,0,0.1)',
                                fontWeight: '600'
                             } : {}}>
                            {dayNumber}
                        </div>
                    </div>
                    <div className="flex-grow overflow-y-auto px-1 pb-1 space-y-1">
                        {/* ë©€í‹°ë°ì´ ì´ë²¤íŠ¸ ì˜ì—­ í™•ë³´ */}
                        <div style={{ height: reservedHeight }} aria-hidden="true" /> 
                         {displayableItems.map((item, index) => {
                            if (item.type === 'holiday') {
                                return (
                                     <div key={`item-${index}`} className="text-xs rounded px-1.5 py-0.5 whitespace-nowrap overflow-hidden text-ellipsis bg-gradient-to-b from-red-100 to-red-50 text-red-700 font-medium shadow-sm border border-red-200/50"
                                          style={{boxShadow: '0 2px 4px rgba(239,68,68,0.15), inset 0 1px 0 rgba(255,255,255,0.8)'}}>
                                        {item.content.name}
                                    </div>
                                )
                            }
                            if (item.type === 'event') {
                                const event = item.content;
                                // --- [FIX 4] START: í•˜ë“œì½”ë”©ëœ 'text-black' ì œê±° ---
                                return (
                                    <div key={`item-${index}`} className={`text-xs rounded px-1.5 py-0.5 whitespace-nowrap overflow-hidden text-ellipsis ${event.color} font-medium shadow-sm border border-opacity-30`}
                                         style={{boxShadow: '0 2px 4px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.6)'}}>
                                        {event.title}
                                    </div>
                                )
                                // --- [FIX 4] END ---
                            }
                            return null;
                        })}
                        {hasMoreItems && (
                            <div className="text-xs text-slate-500 font-medium px-1.5 py-0.5">
                                + {moreItemsCount} more
                            </div>
                        )}
                    </div>
                    {dayData?.teacherDuty && (
                        <div className="flex-shrink-0 p-1 text-center text-xs font-medium text-slate-600 truncate border-t border-slate-200 mt-1 bg-gradient-to-r from-slate-50/50 to-slate-50"
                             style={{boxShadow: 'inset 0 1px 0 rgba(255,255,255,0.8)'}}>
                            {dayData.teacherDuty.teacher}
                        </div>
                    )}
                </div>
            );
        };

        const Calendar = ({ viewDate, startOfWeek: startOfWeekProp, calendarData, onDayClick }) => {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);

            // ë‹¬ë ¥ ì‹œì‘ ë‚ ì§œ ê³„ì‚°
            const startDate = new Date(firstDayOfMonth);
            const startDayOfWeek = firstDayOfMonth.getDay();
            const diff = (startDayOfWeek - startOfWeekProp + 7) % 7;
            startDate.setDate(startDate.getDate() - diff);

            // ë‹¬ë ¥ ë ë‚ ì§œ ê³„ì‚°
            const endDate = new Date(lastDayOfMonth);
            const endDayOfWeek = lastDayOfMonth.getDay();
            const endDiff = (6 - (endDayOfWeek - startOfWeekProp + 7) % 7);
            endDate.setDate(endDate.getDate() + endDiff);

            const weeks = [];
            let currentWeek = [];
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                currentWeek.push(new Date(currentDate));
                if (currentWeek.length === 7) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
             if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }

            const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            if (startOfWeekProp === 1) {
                dayHeaders.push(dayHeaders.shift());
            }

            const today = new Date();
            const todayKey = formatDateKey(today);

            const getWeekMultiDayEvents = (week) => {
                if (!calendarData) return [];
                const weekStart = week[0];
                const weekEnd = week[6];
                // ë‚ ì§œ ë¹„êµë¥¼ ìœ„í•´ ì‹œë¶„ì´ˆë¥¼ 0ìœ¼ë¡œ ì„¤ì •
                weekEnd.setHours(23,59,59,999); 
                return calendarData.multiDayEvents.filter(event => 
                    event.start <= weekEnd && event.end >= weekStart
                );
            }

            const dayHeaderTopAreaHeight = '1.8rem';
            const multiDayEventHeight = '1.4rem';

            return (
                <div className="border-t border-l border-slate-300 bg-white flex flex-col flex-grow shadow-lg rounded-xl overflow-hidden">
                    {/* ìš”ì¼ í—¤ë” */}
                    <div className="grid grid-cols-7">
                        {dayHeaders.map((day, index) => (
                            <div key={index} className={`bg-blue-600 text-white text-center py-2 text-sm font-semibold border-r border-b border-blue-700`}>
                                {day}
                            </div>
                        ))}
                    </div>
                    {/* ë‚ ì§œ ê·¸ë¦¬ë“œ */}
                    <div className="flex-grow grid grid-rows-auto">
                        {weeks.map((week, weekIndex) => {
                            const multiDayEventsInWeek = getWeekMultiDayEvents(week);
                            const maxLanes = multiDayEventsInWeek.length > 0 ? Math.max(...multiDayEventsInWeek.map(e => e.lane)) + 1 : 0;
                            // ë©€í‹°ë°ì´ ì´ë²¤íŠ¸ í‘œì‹œë¥¼ ìœ„í•œ ë†’ì´ ì˜ˆì•½
                            const reservedHeight = `calc(${maxLanes} * ${multiDayEventHeight})`;

                            return (
                                <div key={weekIndex} className="grid grid-cols-7 relative border-b border-slate-300" 
                                     style={{ minHeight: '120px' }}>
                                    {/* ë©€í‹°ë°ì´ ì´ë²¤íŠ¸ ë°” */}
                                    {multiDayEventsInWeek.map(event => {
                                        const weekStart = new Date(week[0]);
                                        weekStart.setHours(0,0,0,0);

                                        const eventStart = new Date(event.start);
                                        eventStart.setHours(0,0,0,0);
                                        
                                        const eventEnd = new Date(event.end);
                                        eventEnd.setHours(0,0,0,0);

                                        // ì´ë²¤íŠ¸ê°€ ì£¼(Week)ì—ì„œ ì‹œì‘í•˜ê±°ë‚˜ ëë‚˜ëŠ” ë‚ ì§œ ì¸ë±ìŠ¤ ê³„ì‚°
                                        const startDayIndex = Math.max(0, Math.round((eventStart.getTime() - weekStart.getTime()) / (1000 * 3600 * 24)));
                                        const endDayIndex = Math.min(6, Math.round((eventEnd.getTime() - weekStart.getTime()) / (1000 * 3600 * 24)));
                                        
                                        const startCol = startDayIndex;
                                        const span = endDayIndex - startDayIndex + 1;
                                        
                                        if (span <= 0) return null;

                                        // --- [FIX 5] START: í•˜ë“œì½”ë”©ëœ 'text-black' ì œê±° (ì—°ì† ì¼ì •) ---
                                        return (
                                            <div 
                                                key={event.id}
                                                className={`absolute text-xs p-1 rounded overflow-hidden text-ellipsis whitespace-nowrap ${event.color} font-semibold shadow-md`}
                                                style={{ 
                                                    top: `calc(${dayHeaderTopAreaHeight} + ${event.lane} * ${multiDayEventHeight})`, 
                                                    left: `calc(${(100 / 7) * startCol}% + 2px)`,
                                                    width: `calc(${(100 / 7) * span}% - 4px)`,
                                                    height: `calc(${multiDayEventHeight} - 2px)`,
                                                    zIndex: 5
                                                }}
                                            >
                                                {event.title}
                                            </div>
                                        )
                                        // --- [FIX 5] END ---
                                    })}

                                    {/* ê°œë³„ ë‚ ì§œ ì…€ */}
                                    {week.map((date) => {
                                        const dateKey = formatDateKey(date);
                                        const dayData = calendarData?.dayDataMap.get(dateKey);
                                        return (
                                            <DayCell
                                                key={dateKey}
                                                date={date}
                                                dayData={dayData}
                                                isToday={dateKey === todayKey}
                                                isCurrentMonth={date.getMonth() === month}
                                                reservedHeight={reservedHeight}
                                                onClick={onDayClick}
                                            />
                                        );
                                    })}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        // --- END: components/Calendar.tsx ---

        // --- START: App.tsx ---

        // --- LocalStorage ê´€ë¦¬ ---
        const StorageManager = {
            // LocalStorage í‚¤ê°€ ë³€ê²½ë˜ë©´ ì•ˆë˜ë¯€ë¡œ, í‚¤ëŠ” ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
            saveEvents: (csv) => localStorage.setItem('schoolEvents', csv),
            saveHolidays: (csv) => localStorage.setItem('schoolHolidays', csv),
            saveSpecialEvents: (csv) => localStorage.setItem('schoolSpecialEvents', csv),
            saveSchoolName: (name) => localStorage.setItem('schoolName', name),
            saveLogo: (logoData) => localStorage.setItem('schoolLogo', logoData),
            removeLogo: () => localStorage.removeItem('schoolLogo'),
            
            getEvents: () => localStorage.getItem('schoolEvents'),
            getHolidays: () => localStorage.getItem('schoolHolidays'),
            getSpecialEvents: () => localStorage.getItem('schoolSpecialEvents'),
            getSchoolName: () => localStorage.getItem('schoolName'),
            getLogo: () => localStorage.getItem('schoolLogo'),
            
            hasData: () => localStorage.getItem('schoolName') !== null,
            clearData: () => {
                localStorage.removeItem('schoolEvents');
                localStorage.removeItem('schoolHolidays');
                localStorage.removeItem('schoolSpecialEvents');
                localStorage.removeItem('schoolName');
                localStorage.removeItem('schoolLogo');
            }
        };

        // --- CSV/Excel íŒŒì¼ ì—…ë¡œë“œ ëª¨ë‹¬ (ìˆ˜ì •ë¨) ---
        const DataUploadModal = ({ onDataLoaded, onClose }) => {
            const [schoolName, setSchoolName] = useState('');
            const [events, setEvents] = useState(null);
            const [holidays, setHolidays] = useState(null);
            const [specialEvents, setSpecialEvents] = useState(null);
            const [logo, setLogo] = useState(null);
            const [uploadedFiles, setUploadedFiles] = useState({
                events: false,
                holidays: false,
                specialEvents: false,
                logo: false
            });
            const [error, setError] = useState('');
            
            // CSV ë˜ëŠ” Excel íŒŒì¼ì„ ì½ì–´ CSV í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” ë²”ìš© í•¸ë“¤ëŸ¬
            const handleFileChange = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                setError(''); // ì˜¤ë¥˜ ì´ˆê¸°í™”

                if (type === 'logo') {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setLogo(event.target.result);
                        setUploadedFiles(prev => ({...prev, logo: true}));
                    };
                    reader.onerror = () => setError("ë¡œê³  íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    reader.readAsDataURL(file);
                    return;
                } 
                
                // ì—‘ì…€ ë˜ëŠ” CSV íŒŒì¼ ì²˜ë¦¬
                const fileName = file.name.toLowerCase();
                const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
                
                const callback = (csvText) => {
                    if (type === 'events') {
                        setEvents(csvText);
                    } else if (type === 'holidays') {
                        setHolidays(csvText);
                    } else if (type === 'specialEvents') {
                        setSpecialEvents(csvText);
                    }
                    setUploadedFiles(prev => ({...prev, [type]: true}));
                    setError('');
                };
                
                const onError = (message) => {
                    setError(message);
                    setUploadedFiles(prev => ({...prev, [type]: false}));
                };

                if (isExcel) {
                    processExcelFile(file, callback, onError);
                } else {
                    processCsvFile(file, callback, onError);
                }
            };

            const handleRemoveLogo = () => {
                setLogo(null);
                setUploadedFiles(prev => ({...prev, logo: false}));
                StorageManager.removeLogo();
            };

            const handleSubmit = () => {
                if (!schoolName.trim()) {
                    setError('í•™êµëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                StorageManager.saveSchoolName(schoolName);
                // íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ CSV í—¤ë”ë¥¼ ì €ì¥
                StorageManager.saveEvents(events || 'ë‚ ì§œ,í–‰ì‚¬');
                StorageManager.saveHolidays(holidays || 'ë‚ ì§œ,ê³µíœ´ì¼ëª…');
                StorageManager.saveSpecialEvents(specialEvents || 'ë‚ ì§œ,ìš”ì¼,í–‰ì‚¬ëª…');
                if (logo) {
                    StorageManager.saveLogo(logo);
                }
                onDataLoaded({
                    schoolName: schoolName,
                    events: events || 'ë‚ ì§œ,í–‰ì‚¬',
                    holidays: holidays || 'ë‚ ì§œ,ê³µíœ´ì¼ëª…',
                    specialEvents: specialEvents || 'ë‚ ì§œ,ìš”ì¼,í–‰ì‚¬ëª…',
                    logo: logo
                });
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
                        <h1 className="text-3xl font-bold text-slate-800 mb-6">ë°ì´í„° ì„¤ì •</h1>
                        <div className="space-y-6">
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <h2 className="font-semibold text-slate-800 mb-4">í•™êµ ì •ë³´</h2>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        í•™êµëª… * <span className="text-xs text-slate-500">(í•„ìˆ˜)</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        placeholder="ì˜ˆ: ì›ë¬µê³ ë“±í•™êµ"
                                        value={schoolName}
                                        onChange={(e) => setSchoolName(e.target.value)}
                                        maxLength={50}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        í•™êµ ë¡œê³  <span className="text-xs text-slate-500">(ì„ íƒ, PNG/JPG íŒŒì¼)</span>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="file" accept="image/*" onChange={(e) => handleFileChange(e, 'logo')} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm" />
                                        {uploadedFiles.logo && <span className="text-green-600 font-semibold">âœ“</span>}
                                    </div>
                                    {logo && (
                                        <div className="mt-3 flex items-center gap-3">
                                            <img src={logo} alt="School Logo" className="h-20 object-contain" />
                                            <button onClick={handleRemoveLogo} className="px-3 py-2 bg-red-100 text-red-700 font-semibold rounded-lg hover:bg-red-200 transition-colors text-sm">ì‚­ì œ</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <h2 className="font-semibold text-slate-800 mb-4">í•™ì‚¬ì¼ì • ë°ì´í„° ì—…ë¡œë“œ</h2>
                                <p className="text-xs text-slate-500 mb-4">íŒŒì¼ í˜•ì‹: CSV ë˜ëŠ” XLSX (ì²« ë²ˆì§¸ ì‹œíŠ¸ë§Œ ì‚¬ìš©)</p>
                                
                                {/* í•™ì‚¬ì¼ì • íŒŒì¼ (CSV/Excel) */}
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        í•™ì‚¬ì¼ì • íŒŒì¼ <span className="text-xs text-slate-500">(ë‚ ì§œ, í–‰ì‚¬1, í–‰ì‚¬2... í˜•ì‹)</span>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="file" accept=".csv, .xlsx, .xls" onChange={(e) => handleFileChange(e, 'events')} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm" />
                                        {uploadedFiles.events && <span className="text-green-600 font-semibold">âœ“</span>}
                                    </div>
                                </div>
                                {/* ê³µíœ´ì¼ íŒŒì¼ (CSV/Excel) */}
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        ê³µíœ´ì¼ íŒŒì¼ <span className="text-xs text-slate-500">(ë‚ ì§œ, ê³µíœ´ì¼ëª… í˜•ì‹)</span>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="file" accept=".csv, .xlsx, .xls" onChange={(e) => handleFileChange(e, 'holidays')} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm" />
                                        {uploadedFiles.holidays && <span className="text-green-600 font-semibold">âœ“</span>}
                                    </div>
                                </div>
                                {/* íŠ¹ë³„ í–‰ì‚¬ íŒŒì¼ (CSV/Excel) */}
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-slate-700 mb-2">
                                        íŠ¹ë³„ í–‰ì‚¬ íŒŒì¼ <span className="text-xs text-slate-500">(ë‚ ì§œ, ìš”ì¼, í–‰ì‚¬ëª…/ì§€ë„êµì‚¬ í˜•ì‹)</span>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="file" accept=".csv, .xlsx, .xls" onChange={(e) => handleFileChange(e, 'specialEvents')} className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm" />
                                        {uploadedFiles.specialEvents && <span className="text-green-600 font-semibold">âœ“</span>}
                                    </div>
                                </div>
                            </div>
                            {error && <div className="p-4 bg-red-100 border border-red-300 rounded-lg text-red-700 text-sm">{error}</div>}
                            <div className="flex gap-3 pt-4">
                                <button onClick={handleSubmit} className="flex-1 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">ì €ì¥</button>
                                <button onClick={onClose} className="flex-1 px-4 py-3 bg-slate-300 text-slate-700 font-semibold rounded-lg hover:bg-slate-400 transition-colors">
                                    ë‹«ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [rawEventsCsv, setRawEventsCsv] = useState('');
            const [rawHolidaysCsv, setRawHolidaysCsv] = useState('');
            const [rawDutiesCsv, setRawDutiesCsv] = useState('');
            const [schoolLogo, setSchoolLogo] = useState(null);
            const [showDataModal, setShowDataModal] = useState(false);
            const [viewDate, setViewDate] = useState(new Date());
            const [startOfWeek, setStartOfWeek] = useState(0);
            const [selectedDay, setSelectedDay] = useState(null);
            const [schoolName, setSchoolName] = useState('');

            const rawEvents = useMemo(() => parseEventsCsv(rawEventsCsv), [rawEventsCsv]);
            const holidays = useMemo(() => parseHolidaysCsv(rawHolidaysCsv), [rawHolidaysCsv]);
            // íŠ¹ë³„ í–‰ì‚¬ íŒŒì¼ì€ ë‹¹ì§ êµì‚¬ ë°ì´í„°ë¡œ ê°„ì£¼í•˜ê³  íŒŒì‹± (ì´ë¦„ì€ Dutyì´ì§€ë§Œ íŠ¹ë³„ í–‰ì‚¬ ë°ì´í„°ë¡œ ì‚¬ìš©)
            const duties = useMemo(() => parseTeachersCsv(rawDutiesCsv), [rawDutiesCsv]); 

            const calendarData = useMemo(() => {
                return processCalendarData(rawEvents, holidays, duties);
            }, [rawEvents, holidays, duties]);

            useEffect(() => {
                // ë¡œê³  ë¡œë“œ
                const savedLogo = StorageManager.getLogo();
                if (savedLogo) {
                    setSchoolLogo(savedLogo);
                }
                
                // í•™êµëª… ë¡œë“œ
                const savedSchoolName = StorageManager.getSchoolName();
                if (savedSchoolName) {
                    setSchoolName(savedSchoolName);
                    setShowDataModal(false);
                } else {
                    // í•™êµëª…ì´ ì—†ìœ¼ë©´ ëª¨ë‹¬ì„ ë„ì›€
                    setShowDataModal(true);
                }
                
                // ë°ì´í„° ë¡œë“œ
                const eventsCsv = StorageManager.getEvents();
                const holidaysCsv = StorageManager.getHolidays();
                const specialEventsCsv = StorageManager.getSpecialEvents();

                // [ìˆ˜ì •] ê° ë°ì´í„°ë¥¼ LocalStorageì—ì„œ ë…ë¦½ì ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤.
                setRawEventsCsv(eventsCsv || '');
                setRawHolidaysCsv(holidaysCsv || '');
                setRawDutiesCsv(specialEventsCsv || '');
                
            }, []);

            const handleDataLoaded = (data) => {
                setSchoolName(data.schoolName);
                setRawEventsCsv(data.events);
                setRawHolidaysCsv(data.holidays);
                setRawDutiesCsv(data.specialEvents);
                if (data.logo) {
                    setSchoolLogo(data.logo);
                }
                setShowDataModal(false);
            };

            const handleReset = () => {
                 // confirm() ëŒ€ì‹  ëª¨ë‹¬ UIë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ì§€ë§Œ, ë¹ ë¥¸ êµ¬í˜„ì„ ìœ„í•´ ì„ì‹œë¡œ ì‚¬ìš©
                if (window.confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¡œê³ , í•™êµëª…, í•™ì‚¬ì¼ì • ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) {
                    StorageManager.clearData();
                    setSchoolName('');
                    setSchoolLogo(null);
                    setRawEventsCsv('');
                    setRawHolidaysCsv('');
                    setRawDutiesCsv('');
                    setShowDataModal(true);
                }
            };


            const handleDayClick = useCallback((dayData) => {
                if (dayData.events.length > 0 || dayData.holiday || dayData.teacherDuty) {
                    setSelectedDay(dayData);
                }
            }, []);

            return (
                <div className="w-full max-w-7xl mx-auto bg-white rounded-2xl shadow-xl flex flex-col min-h-[85vh] overflow-hidden">
                     <Header
                        viewDate={viewDate}
                        setViewDate={setViewDate}
                        startOfWeek={startOfWeek}
                        setStartOfWeek={setStartOfWeek}
                        onReset={handleReset}
                        onShowDataModal={() => setShowDataModal(true)}
                        schoolName={schoolName}
                        schoolLogo={schoolLogo}
                    />
                    <main className="flex-grow p-1 sm:p-2 lg:p-4"> 
                        <Calendar
                            viewDate={viewDate}
                            startOfWeek={startOfWeek}
                            calendarData={calendarData}
                            onDayClick={handleDayClick}
                        />
                    </main>
                    <footer className="p-2 text-center text-xs text-slate-500 border-t border-slate-200">
                        Â© 2025 KH KIM. All Rights Reserved.
                    </footer>
                    {selectedDay && (
                        <EventModal dayData={selectedDay} onClose={() => setSelectedDay(null)} />
                    )}
                    {showDataModal && (
                        <DataUploadModal 
                            onDataLoaded={handleDataLoaded} 
                            onClose={() => setShowDataModal(false)} 
                        />
                    )}
                </div>
            );
        };
        // --- END: App.tsx ---

        // --- START: index.tsx (Mounting Logic) ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
        // --- END: index.tsx ---
    </script>
</body>
</html>

